import { LendingProtocol } from './lending-protocol';
import { Portfolio } from 'src/protocol.portfolio';
import * as common from '@protocolink/common';
import { expect } from 'chai';
import { filterPortfolio } from 'src/protocol.utils';

describe('Test Aave V3 LendingProtocol', function () {
  context('Test getPortfolio', function () {
    const testCases = [
      {
        chainId: common.ChainId.mainnet,
        account: '0xAF06acFD1BD492B913d5807d562e4FC3A6343C4E',
        blockTag: 18797586,
        expected: {
          chainId: 1,
          protocolId: 'aave-v3',
          marketId: 'mainnet',
          utilization: '1',
          healthRate: '0.93258246248607674253',
          netAPY: '0.05975227791860128594',
          totalSupplyUSD: '58114237.16604937106663955975306072',
          totalBorrowUSD: '50463931.85681213194668127693048362',
          supplies: [
            {
              token: {
                chainId: 1,
                address: '0x7Fc66500c84A76Ad7e9c93437bFc5Ac33E2DDaE9',
                decimals: 18,
                symbol: 'AAVE',
                name: 'Aave Token',
              },
              price: '105.0112',
              balance: '0',
              apy: '0',
              lstApy: '0',
              grossApy: '0',
              usageAsCollateralEnabled: true,
              ltv: '0.66',
              liquidationThreshold: '0.73',
              isNotCollateral: false,
              supplyCap: '1850000',
              totalSupply: '664698.902796470253474238',
            },
            {
              token: {
                chainId: 1,
                address: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
                decimals: 18,
                symbol: 'DAI',
                name: 'Dai Stablecoin',
              },
              price: '1.00002272',
              balance: '0',
              apy: '0.04054069979413997238',
              lstApy: '0',
              grossApy: '0.04054069979413997238',
              usageAsCollateralEnabled: true,
              ltv: '0.77',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '338000000',
              totalSupply: '92918136.653764994943597984',
            },
            {
              token: {
                chainId: 1,
                address: '0x514910771AF9Ca656af840dff83E8264EcF986CA',
                decimals: 18,
                symbol: 'LINK',
                name: 'ChainLink Token',
              },
              price: '14.43048',
              balance: '0',
              apy: '0.00011292316266079384',
              lstApy: '0',
              grossApy: '0.00011292316266079384',
              usageAsCollateralEnabled: true,
              ltv: '0.53',
              liquidationThreshold: '0.68',
              isNotCollateral: false,
              supplyCap: '15000000',
              totalSupply: '6236919.227547270114317598',
            },
            {
              token: {
                chainId: 1,
                address: '0x5f98805A4E8be255a32880FDeC7F6728C6568bA0',
                decimals: 18,
                symbol: 'LUSD',
                name: 'LUSD Stablecoin',
              },
              price: '0.99907346',
              balance: '0',
              apy: '0.03577655473827457357',
              lstApy: '0',
              grossApy: '0.03577655473827457357',
              usageAsCollateralEnabled: true,
              ltv: '0.77',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '18000000',
              totalSupply: '5896849.384296611014905182',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balance: '0',
              apy: '0.04129249914555541349',
              lstApy: '0',
              grossApy: '0.04129249914555541349',
              usageAsCollateralEnabled: true,
              ltv: '0.77',
              liquidationThreshold: '0.8',
              isNotCollateral: false,
              supplyCap: '1760000000',
              totalSupply: '451741481.616413',
            },
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balance: '215169.250899',
              apy: '0.04113888262414266182',
              lstApy: '0',
              grossApy: '0.04113888262414266182',
              usageAsCollateralEnabled: true,
              ltv: '0.74',
              liquidationThreshold: '0.76',
              isNotCollateral: false,
              supplyCap: '600000000',
              totalSupply: '397684811.506379',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42070.43411843',
              balance: '0',
              apy: '0.00088069472003505139',
              lstApy: '0',
              grossApy: '0.00088069472003505139',
              usageAsCollateralEnabled: true,
              ltv: '0.73',
              liquidationThreshold: '0.78',
              isNotCollateral: false,
              supplyCap: '43000',
              totalSupply: '11963.09759525',
            },
            {
              token: {
                chainId: 1,
                address: '0xBe9895146f7AF43049ca1c1AE358B0541Ea49704',
                decimals: 18,
                symbol: 'cbETH',
                name: 'Coinbase Wrapped Staked ETH',
              },
              price: '2367.23327843',
              balance: '0',
              apy: '0.00066155636243544685',
              lstApy: '0.0274',
              grossApy: '0.02806155636243544685',
              usageAsCollateralEnabled: true,
              ltv: '0.745',
              liquidationThreshold: '0.77',
              isNotCollateral: false,
              supplyCap: '60000',
              totalSupply: '12515.931125102669761257',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balance: '0',
              apy: '0.00080602066709354148',
              lstApy: '0.0275',
              grossApy: '0.02830602066709354148',
              usageAsCollateralEnabled: true,
              ltv: '0.745',
              liquidationThreshold: '0.77',
              isNotCollateral: false,
              supplyCap: '60000',
              totalSupply: '48356.818649881665030164',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balance: '22447.507781248636639372',
              apy: '0.00002953692637359529',
              lstApy: '0.0324',
              grossApy: '0.03242953692637359529',
              usageAsCollateralEnabled: true,
              ltv: '0.785',
              liquidationThreshold: '0.81',
              isNotCollateral: false,
              supplyCap: '1100000',
              totalSupply: '766378.435528436226868079',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balance: '0',
              apy: '0.01912664906969010559',
              lstApy: '0',
              grossApy: '0.01912664906969010559',
              usageAsCollateralEnabled: true,
              ltv: '0.805',
              liquidationThreshold: '0.83',
              isNotCollateral: false,
              supplyCap: '1800000',
              totalSupply: '456717.169430435071384223',
            },
            {
              token: {
                chainId: 1,
                address: '0xba100000625a3754423978a60c9317c58a424e3D',
                decimals: 18,
                symbol: 'BAL',
                name: 'Balancer',
              },
              price: '4.00584039',
              balance: '0',
              apy: '0.02641882601000881679',
              lstApy: '0',
              grossApy: '0.02641882601000881679',
              usageAsCollateralEnabled: false,
              ltv: '0.57',
              liquidationThreshold: '0.62',
              isNotCollateral: false,
              supplyCap: '700000',
              totalSupply: '430927.692213809294956654',
            },
            {
              token: {
                chainId: 1,
                address: '0xD533a949740bb3306d119CC777fa900bA034cd52',
                decimals: 18,
                symbol: 'CRV',
                name: 'Curve DAO Token',
              },
              price: '0.64126945',
              balance: '0',
              apy: '0.00537209814152129923',
              lstApy: '0',
              grossApy: '0.00537209814152129923',
              usageAsCollateralEnabled: false,
              ltv: '0.35',
              liquidationThreshold: '0.41',
              isNotCollateral: false,
              supplyCap: '7500000',
              totalSupply: '2173163.169937050727109039',
            },
            {
              token: {
                chainId: 1,
                address: '0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72',
                decimals: 18,
                symbol: 'ENS',
                name: 'Ethereum Name Service',
              },
              price: '8.70661924',
              balance: '0',
              apy: '0.00031956336766001557',
              lstApy: '0',
              grossApy: '0.00031956336766001557',
              usageAsCollateralEnabled: false,
              ltv: '0.39',
              liquidationThreshold: '0.49',
              isNotCollateral: false,
              supplyCap: '1000000',
              totalSupply: '44639.909893333904305634',
            },
            {
              token: {
                chainId: 1,
                address: '0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32',
                decimals: 18,
                symbol: 'LDO',
                name: 'Lido DAO Token',
              },
              price: '2.15865322',
              balance: '0',
              apy: '0.00000908766059742753',
              lstApy: '0',
              grossApy: '0.00000908766059742753',
              usageAsCollateralEnabled: false,
              ltv: '0.4',
              liquidationThreshold: '0.5',
              isNotCollateral: false,
              supplyCap: '6000000',
              totalSupply: '1063337.005393092033367612',
            },
            {
              token: {
                chainId: 1,
                address: '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2',
                decimals: 18,
                symbol: 'MKR',
                name: 'Maker',
              },
              price: '1325.12484',
              balance: '0',
              apy: '0.00055163255868484246',
              lstApy: '0',
              grossApy: '0.00055163255868484246',
              usageAsCollateralEnabled: false,
              ltv: '0.65',
              liquidationThreshold: '0.7',
              isNotCollateral: false,
              supplyCap: '22500',
              totalSupply: '10681.629597624166611382',
            },
            {
              token: {
                chainId: 1,
                address: '0xC011a73ee8576Fb46F5E1c5751cA3B9Fe0af2a6F',
                decimals: 18,
                symbol: 'SNX',
                name: 'Synthetix Network Token',
              },
              price: '4.10424827',
              balance: '0',
              apy: '0.01535264061137685515',
              lstApy: '0',
              grossApy: '0.01535264061137685515',
              usageAsCollateralEnabled: false,
              ltv: '0.49',
              liquidationThreshold: '0.65',
              isNotCollateral: false,
              supplyCap: '2000000',
              totalSupply: '640607.360335350777431324',
            },
            {
              token: {
                chainId: 1,
                address: '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984',
                decimals: 18,
                symbol: 'UNI',
                name: 'Uniswap',
              },
              price: '6.1537289',
              balance: '0',
              apy: '0.0001541144618494753',
              lstApy: '0',
              grossApy: '0.0001541144618494753',
              usageAsCollateralEnabled: false,
              ltv: '0.65',
              liquidationThreshold: '0.77',
              isNotCollateral: false,
              supplyCap: '4000000',
              totalSupply: '2408925.806808387476923232',
            },
            {
              token: {
                chainId: 1,
                address: '0x111111111117dC0aa78b770fA6A738034120C302',
                decimals: 18,
                symbol: '1INCH',
                name: '1INCH Token',
              },
              price: '0.36715648',
              balance: '0',
              apy: '0.00001417275829874642',
              lstApy: '0',
              grossApy: '0.00001417275829874642',
              usageAsCollateralEnabled: false,
              ltv: '0.57',
              liquidationThreshold: '0.67',
              isNotCollateral: false,
              supplyCap: '22000000',
              totalSupply: '1284901.062132648467095204',
            },
            {
              token: {
                chainId: 1,
                address: '0x853d955aCEf822Db058eb8505911ED77F175b99e',
                decimals: 18,
                symbol: 'FRAX',
                name: 'Frax',
              },
              price: '0.99929064',
              balance: '0',
              apy: '0.03601976661346056869',
              lstApy: '0',
              grossApy: '0.03601976661346056869',
              usageAsCollateralEnabled: false,
              ltv: '0.7',
              liquidationThreshold: '0.75',
              isNotCollateral: false,
              supplyCap: '15000000',
              totalSupply: '688658.291640712360126327',
            },
            {
              token: {
                chainId: 1,
                address: '0xD33526068D116cE69F19A9ee46F0bd304F21A51f',
                decimals: 18,
                symbol: 'RPL',
                name: 'Rocket Pool Protocol',
              },
              price: '27.19493893',
              balance: '0',
              apy: '0.01559754249123508373',
              lstApy: '0',
              grossApy: '0.01559754249123508373',
              usageAsCollateralEnabled: false,
              ltv: '0',
              liquidationThreshold: '0',
              isNotCollateral: false,
              supplyCap: '840000',
              totalSupply: '451515.769089415208475783',
            },
            {
              token: {
                chainId: 1,
                address: '0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6',
                decimals: 18,
                symbol: 'STG',
                name: 'StargateToken',
              },
              price: '0.51794661',
              balance: '0',
              apy: '0.00000010978549004967',
              lstApy: '0',
              grossApy: '0.00000010978549004967',
              usageAsCollateralEnabled: false,
              ltv: '0.35',
              liquidationThreshold: '0.4',
              isNotCollateral: false,
              supplyCap: '10000000',
              totalSupply: '2004551.693873044729337211',
            },
            {
              token: {
                chainId: 1,
                address: '0xdeFA4e8a7bcBA345F687a2f1456F5Edd9CE97202',
                decimals: 18,
                symbol: 'KNC',
                name: 'Kyber Network Crystal v2',
              },
              price: '0.70404347',
              balance: '0',
              apy: '0.16162982443989215223',
              lstApy: '0',
              grossApy: '0.16162982443989215223',
              usageAsCollateralEnabled: false,
              ltv: '0.35',
              liquidationThreshold: '0.4',
              isNotCollateral: false,
              supplyCap: '1200000',
              totalSupply: '203598.367259294307723868',
            },
            {
              token: {
                chainId: 1,
                address: '0x3432B6A60D23Ca0dFCa7761B7ab56459D9C964D0',
                decimals: 18,
                symbol: 'FXS',
                name: 'Frax Share',
              },
              price: '8.58585071',
              balance: '0',
              apy: '0',
              lstApy: '0',
              grossApy: '0',
              usageAsCollateralEnabled: false,
              ltv: '0.35',
              liquidationThreshold: '0.45',
              isNotCollateral: false,
              supplyCap: '800000',
              totalSupply: '14018.815218722342773996',
            },
            {
              token: {
                chainId: 1,
                address: '0xf939E0A03FB07F59A73314E73794Be0E57ac1b4E',
                decimals: 18,
                symbol: 'crvUSD',
                name: 'Curve.Fi USD Stablecoin',
              },
              price: '0.9987005',
              balance: '0',
              apy: '0.03227369175779659042',
              lstApy: '0',
              grossApy: '0.03227369175779659042',
              usageAsCollateralEnabled: false,
              ltv: '0',
              liquidationThreshold: '0',
              isNotCollateral: false,
              supplyCap: '60000000',
              totalSupply: '139063.257077173287449294',
            },
          ],
          borrows: [
            {
              token: {
                chainId: 1,
                address: '0x6B175474E89094C44Da98b954EedeAC495271d0F',
                decimals: 18,
                symbol: 'DAI',
                name: 'Dai Stablecoin',
              },
              price: '1.00002272',
              balance: '0',
              apy: '0.05077600393079828611',
              lstApy: '0',
              grossApy: '0.05077600393079828611',
              borrowMin: '0',
              borrowCap: '271000000',
              totalBorrow: '82838987.172690904611446783',
            },
            {
              token: {
                chainId: 1,
                address: '0x514910771AF9Ca656af840dff83E8264EcF986CA',
                decimals: 18,
                symbol: 'LINK',
                name: 'ChainLink Token',
              },
              price: '14.43048',
              balance: '0',
              apy: '0.00469672266338061558',
              lstApy: '0',
              grossApy: '0.00469672266338061558',
              borrowMin: '0',
              borrowCap: '13000000',
              totalBorrow: '187871.836490316380222276',
            },
            {
              token: {
                chainId: 1,
                address: '0x5f98805A4E8be255a32880FDeC7F6728C6568bA0',
                decimals: 18,
                symbol: 'LUSD',
                name: 'LUSD Stablecoin',
              },
              price: '0.99907346',
              balance: '0',
              apy: '0.05064809600568456771',
              lstApy: '0',
              grossApy: '0.05064809600568456771',
              borrowMin: '0',
              borrowCap: '8000000',
              totalBorrow: '4661610.161174071343711259',
            },
            {
              token: {
                chainId: 1,
                address: '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                decimals: 6,
                symbol: 'USDC',
                name: 'USD Coin',
              },
              price: '1.00027726',
              balance: '0',
              apy: '0.05124690480066431282',
              lstApy: '0',
              grossApy: '0.05124690480066431282',
              borrowMin: '0',
              borrowCap: '1580000000',
              totalBorrow: '406390100.165723',
            },
            {
              token: {
                chainId: 1,
                address: '0xdAC17F958D2ee523a2206206994597C13D831ec7',
                decimals: 6,
                symbol: 'USDT',
                name: 'Tether USD',
              },
              price: '0.99961',
              balance: '0',
              apy: '0.05115103904810626772',
              lstApy: '0',
              grossApy: '0.05115103904810626772',
              borrowMin: '0',
              borrowCap: '500000000',
              totalBorrow: '357102470.630928',
            },
            {
              token: {
                chainId: 1,
                address: '0x2260FAC5E5542a773Aa44fBCfeDf7C193bc2C599',
                decimals: 8,
                symbol: 'WBTC',
                name: 'Wrapped BTC',
              },
              price: '42070.43411843',
              balance: '0',
              apy: '0.00993905766729966149',
              lstApy: '0',
              grossApy: '0.00993905766729966149',
              borrowMin: '0',
              borrowCap: '28000',
              totalBorrow: '1331.04368336',
            },
            {
              token: {
                chainId: 1,
                address: '0xBe9895146f7AF43049ca1c1AE358B0541Ea49704',
                decimals: 18,
                symbol: 'cbETH',
                name: 'Coinbase Wrapped Staked ETH',
              },
              price: '2367.23327843',
              balance: '0',
              apy: '0.01106206012748106734',
              lstApy: '0.0274',
              grossApy: '-0.01633793987251893266',
              borrowMin: '0',
              borrowCap: '2400',
              totalBorrow: '885.162922097405223302',
            },
            {
              token: {
                chainId: 1,
                address: '0xae78736Cd615f374D3085123A210448E74Fc6393',
                decimals: 18,
                symbol: 'rETH',
                name: 'Rocket Pool ETH',
              },
              price: '2450.18252296',
              balance: '0',
              apy: '0.01221682491528295028',
              lstApy: '0.0275',
              grossApy: '-0.01528317508471704972',
              borrowMin: '0',
              borrowCap: '19200',
              totalBorrow: '3774.785469677145439116',
            },
            {
              token: {
                chainId: 1,
                address: '0x7f39C581F595B53c5cb19bD0b3f8dA6c935E2Ca0',
                decimals: 18,
                symbol: 'wstETH',
                name: 'Wrapped liquid staked Ether 2.0',
              },
              price: '2579.31314226',
              balance: '0.000000000199591537',
              apy: '0.00350052367445749632',
              lstApy: '0.0324',
              grossApy: '-0.02889947632554250368',
              borrowMin: '0',
              borrowCap: '24000',
              totalBorrow: '7620.954012786860698391',
            },
            {
              token: {
                chainId: 1,
                address: '0x0000000000000000000000000000000000000000',
                decimals: 18,
                symbol: 'ETH',
                name: 'Ethereum',
              },
              price: '2242.39893',
              balance: '22504.439857546496928451',
              apy: '0.02832454450272690728',
              lstApy: '0',
              grossApy: '0.02832454450272690728',
              borrowMin: '0',
              borrowCap: '1400000',
              totalBorrow: '364472.9473151526740187',
            },
            {
              token: {
                chainId: 1,
                address: '0xba100000625a3754423978a60c9317c58a424e3D',
                decimals: 18,
                symbol: 'BAL',
                name: 'Balancer',
              },
              price: '4.00584039',
              balance: '0',
              apy: '0.13079543144860774213',
              lstApy: '0',
              grossApy: '0.13079543144860774213',
              borrowMin: '0',
              borrowCap: '185000',
              totalBorrow: '114456.291227146335280441',
            },
            {
              token: {
                chainId: 1,
                address: '0xD533a949740bb3306d119CC777fa900bA034cd52',
                decimals: 18,
                symbol: 'CRV',
                name: 'Curve DAO Token',
              },
              price: '0.64126945',
              balance: '0',
              apy: '0.06001629796737378854',
              lstApy: '0',
              grossApy: '0.06001629796737378854',
              borrowMin: '0',
              borrowCap: '5000000',
              totalBorrow: '307508.291167649884187053',
            },
            {
              token: {
                chainId: 1,
                address: '0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72',
                decimals: 18,
                symbol: 'ENS',
                name: 'Ethereum Name Service',
              },
              price: '8.70661924',
              balance: '0',
              apy: '0.00897751203969010139',
              lstApy: '0',
              grossApy: '0.00897751203969010139',
              borrowMin: '0',
              borrowCap: '40000',
              totalBorrow: '1995.184522027963041865',
            },
            {
              token: {
                chainId: 1,
                address: '0x5A98FcBEA516Cf06857215779Fd812CA3beF1B32',
                decimals: 18,
                symbol: 'LDO',
                name: 'Lido DAO Token',
              },
              price: '2.15865322',
              balance: '0',
              apy: '0.00133018338243446772',
              lstApy: '0',
              grossApy: '0.00133018338243446772',
              borrowMin: '0',
              borrowCap: '3000000',
              totalBorrow: '9086.759136089184224493',
            },
            {
              token: {
                chainId: 1,
                address: '0x9f8F72aA9304c8B593d555F12eF6589cC3A579A2',
                decimals: 18,
                symbol: 'MKR',
                name: 'Maker',
              },
              price: '1325.12484',
              balance: '0',
              apy: '0.0104091053083956077',
              lstApy: '0',
              grossApy: '0.0104091053083956077',
              borrowMin: '0',
              borrowCap: '3000',
              totalBorrow: '711.084235034181327029',
            },
            {
              token: {
                chainId: 1,
                address: '0xC011a73ee8576Fb46F5E1c5751cA3B9Fe0af2a6F',
                decimals: 18,
                symbol: 'SNX',
                name: 'Synthetix Network Token',
              },
              price: '4.10424827',
              balance: '0',
              apy: '0.08650980183324964408',
              lstApy: '0',
              grossApy: '0.08650980183324964408',
              borrowMin: '0',
              borrowCap: '1100000',
              totalBorrow: '180987.280847909227098604',
            },
            {
              token: {
                chainId: 1,
                address: '0x1f9840a85d5aF5bf1D1762F925BDADdC4201F984',
                decimals: 18,
                symbol: 'UNI',
                name: 'Uniswap',
              },
              price: '6.1537289',
              balance: '0',
              apy: '0.00548898362962160323',
              lstApy: '0',
              grossApy: '0.00548898362962160323',
              borrowMin: '0',
              borrowCap: '500000',
              totalBorrow: '84770.250092805917840859',
            },
            {
              token: {
                chainId: 1,
                address: '0x40D16FC0246aD3160Ccc09B8D0D3A2cD28aE6C2f',
                decimals: 18,
                symbol: 'GHO',
                name: 'Gho Token',
              },
              price: '1',
              balance: '0',
              apy: '0.05358643868526975825',
              lstApy: '0',
              grossApy: '0.05358643868526975825',
              borrowMin: '0',
              borrowCap: '35000000',
              totalBorrow: '35001304.853742346875010307',
            },
            {
              token: {
                chainId: 1,
                address: '0x111111111117dC0aa78b770fA6A738034120C302',
                decimals: 18,
                symbol: '1INCH',
                name: '1INCH Token',
              },
              price: '0.36715648',
              balance: '0',
              apy: '0.00188410222613479303',
              lstApy: '0',
              grossApy: '0.00188410222613479303',
              borrowMin: '0',
              borrowCap: '720000',
              totalBorrow: '12093.125945788493413928',
            },
            {
              token: {
                chainId: 1,
                address: '0x853d955aCEf822Db058eb8505911ED77F175b99e',
                decimals: 18,
                symbol: 'FRAX',
                name: 'Frax',
              },
              price: '0.99929064',
              balance: '0',
              apy: '0.0478462503067623037',
              lstApy: '0',
              grossApy: '0.0478462503067623037',
              borrowMin: '0',
              borrowCap: '12000000',
              totalBorrow: '579355.922074445957174638',
            },
            {
              token: {
                chainId: 1,
                address: '0xD33526068D116cE69F19A9ee46F0bd304F21A51f',
                decimals: 18,
                symbol: 'RPL',
                name: 'Rocket Pool Protocol',
              },
              price: '27.19493893',
              balance: '0',
              apy: '0.04638176421561664829',
              lstApy: '0',
              grossApy: '0.04638176421561664829',
              borrowMin: '0',
              borrowCap: '480000',
              totalBorrow: '192691.126841746370860172',
            },
            {
              token: {
                chainId: 1,
                address: '0xdeFA4e8a7bcBA345F687a2f1456F5Edd9CE97202',
                decimals: 18,
                symbol: 'KNC',
                name: 'Kyber Network Crystal v2',
              },
              price: '0.70404347',
              balance: '0',
              apy: '0.45228185272606608958',
              lstApy: '0',
              grossApy: '0.45228185272606608958',
              borrowMin: '0',
              borrowCap: '650000',
              totalBorrow: '102217.846911972107952927',
            },
            {
              token: {
                chainId: 1,
                address: '0xf939E0A03FB07F59A73314E73794Be0E57ac1b4E',
                decimals: 18,
                symbol: 'crvUSD',
                name: 'Curve.Fi USD Stablecoin',
              },
              price: '0.9987005',
              balance: '0',
              apy: '0.04808656168165237238',
              lstApy: '0',
              grossApy: '0.04808656168165237238',
              borrowMin: '0',
              borrowCap: '50000000',
              totalBorrow: '104506.605695275372946496',
            },
          ],
        },
      },
    ];

    testCases.forEach(({ chainId, account, blockTag, expected }) => {
      it(`${common.toNetworkId(chainId)} market`, async function () {
        const protocol = await LendingProtocol.createProtocol(chainId);

        protocol.setBlockTag(blockTag);
        const _portfolio = await protocol.getPortfolio(account);
        const portfolio: Portfolio = JSON.parse(JSON.stringify(_portfolio));

        const filteredPortfolio = filterPortfolio(portfolio);
        const filteredExpected = filterPortfolio(expected);

        expect(filteredPortfolio).to.deep.equal(filteredExpected);
      }).timeout(30000);
    });
  });
});
